name: CD - Deploy to UAT

on:
  workflow_run:
    workflows: ["CI - Data Platform Validation"]
    types: [completed]

permissions:
  contents: read
  actions: read

jobs:
  deploy-uat:
    if: >
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.head_branch == 'env/uat'

    runs-on: ubuntu-latest
    environment: uat

    steps:
      - name: Show workflow context (traceability)
        run: |
          echo "CI Run ID : ${{ github.event.workflow_run.id }}"
          echo "Branch    : ${{ github.event.workflow_run.head_branch }}"
          echo "Commit    : ${{ github.event.workflow_run.head_sha }}"

      - name: Download CI artifact (from triggering run)
        uses: actions/download-artifact@v4
        with:
          run-id: ${{ github.event.workflow_run.id }}
          name: build_${{ github.event.workflow_run.head_sha }}
          path: ./artifact
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Unzip artifact
        shell: bash
        run: |
          unzip -q "./artifact/build_${{ github.event.workflow_run.head_sha }}.zip" -d ./artifact/unzipped

      - name: UAT deployment summary (demo)
        run: |
          echo "Deploying artifact build_${{ github.event.workflow_run.head_sha }} to UAT..."
          echo "UAT deployment completed âœ…"