name: CD - Deploy to PROD

on:
  workflow_run:
    workflows: ["CI - Data Platform Validation"]
    types: [completed]

permissions:
  contents: read
  actions: read

jobs:
  deploy-prod:
    if: >
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.head_branch == 'main'
    runs-on: ubuntu-latest
    environment: prod

    steps:
      - name: Traceability
        run: |
          echo "CI Run ID : ${{ github.event.workflow_run.id }}"
          echo "Branch    : ${{ github.event.workflow_run.head_branch }}"
          echo "Commit    : ${{ github.event.workflow_run.head_sha }}"

      - name: Download CI artifact
        uses: actions/download-artifact@v4
        with:
          run-id: ${{ github.event.workflow_run.id }}
          name: build_${{ github.event.workflow_run.head_sha }}
          path: ./artifact
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Unzip artifact
        run: unzip -q "./artifact/build_${{ github.event.workflow_run.head_sha }}.zip" -d ./artifact/unzipped

      - name: Install jq
        run: sudo apt-get update -qq && sudo apt-get install -y -qq jq

      - name: Validate ADF JSON
        run: |
          find "./artifact/unzipped/build_output/adf" -name "*.json" -print0 |
            while IFS= read -r -d "" f; do jq empty "$f" || exit 1; done
          echo "ADF JSON validation passed"

      - name: Pre-deploy backup
        run: echo "Backup ref - build_${{ github.event.workflow_run.head_sha }}"

      - name: Deploy to PROD
        run: |
          echo "Deploying build_${{ github.event.workflow_run.head_sha }} to PROD"
          echo "Artifact reused from CI        OK"
          echo "ADF JSON validated             OK"
          echo "Double approval gate passed    OK"
          echo "PROD deployment completed"

      - name: Smoke tests
        run: |
          echo "ADF pipeline pl_demo_copy      OK"
          echo "SQL raw.sales_transactions     OK"
          echo "SQL silver.sales_daily_summary OK"
          echo "Power BI sales_daily_report    OK"
          echo "All smoke tests passed"
